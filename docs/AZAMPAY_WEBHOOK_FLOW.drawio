<mxfile host="app.diagrams.net">
  <diagram name="Sandbox vs Production" id="sandbox-production">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="827" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Title -->
        <mxCell id="title" value="AzamPay Payment Flow: Sandbox vs Production" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=20;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="320" y="20" width="530" height="40" as="geometry" />
        </mxCell>
        
        <!-- SANDBOX SECTION -->
        <mxCell id="sandbox-title" value="ðŸ§ª SANDBOX (Testing)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=16;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="520" height="40" as="geometry" />
        </mxCell>
        
        <!-- Sandbox Actors -->
        <mxCell id="sb-frontend" value="Frontend" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="80" y="140" width="40" height="80" as="geometry" />
        </mxCell>
        
        <mxCell id="sb-backend" value="Backend&lt;br&gt;Django" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="180" y="150" width="100" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="sb-azampay" value="AzamPay&lt;br&gt;Sandbox" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="340" y="150" width="100" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="sb-customer" value="Customer" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="490" y="140" width="40" height="80" as="geometry" />
        </mxCell>
        
        <!-- Sandbox Flow Arrows -->
        <mxCell id="sb-arrow1" value="1. Initiate Payment" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.25;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;strokeColor=#000000;" edge="1" parent="1" source="sb-frontend" target="sb-backend">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="120" y="165" as="sourcePoint" />
            <mxPoint x="180" y="165" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="sb-arrow2" value="2. POST /mno/checkout" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=#000000;" edge="1" parent="1" source="sb-backend" target="sb-azampay">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="sb-arrow3" value="3. transactionId" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.75;exitDx=0;exitDy=0;entryX=1;entryY=0.75;entryDx=0;entryDy=0;strokeColor=#000000;dashed=1;" edge="1" parent="1" source="sb-azampay" target="sb-backend">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="sb-arrow4" value="4. PENDING" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.75;exitDx=0;exitDy=0;entryX=1;entryY=0.75;entryDx=0;entryDy=0;strokeColor=#000000;dashed=1;" edge="1" parent="1" source="sb-backend" target="sb-frontend">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="180" y="195" as="sourcePoint" />
            <mxPoint x="120" y="195" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Sandbox Warning Box -->
        <mxCell id="sb-warning" value="âš ï¸ Webhook NOT sent in sandbox&lt;br&gt;Status remains PENDING" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcccc;strokeColor=#ff0000;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="180" y="260" width="260" height="60" as="geometry" />
        </mxCell>
        
        <!-- Sandbox Manual Check -->
        <mxCell id="sb-manual" value="5. Manual Status Check" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;strokeColor=#ff9900;strokeWidth=2;dashed=1;" edge="1" parent="1" source="sb-backend" target="sb-azampay">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="230" y="350" />
              <mxPoint x="390" y="350" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <!-- PRODUCTION SECTION -->
        <mxCell id="prod-title" value="ðŸš€ PRODUCTION (Live)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=16;fontStyle=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="610" y="80" width="520" height="40" as="geometry" />
        </mxCell>
        
        <!-- Production Actors -->
        <mxCell id="pr-frontend" value="Frontend" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="650" y="140" width="40" height="80" as="geometry" />
        </mxCell>
        
        <mxCell id="pr-backend" value="Backend&lt;br&gt;Django" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="750" y="150" width="100" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="pr-azampay" value="AzamPay&lt;br&gt;Production" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="910" y="150" width="100" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="pr-customer" value="Customer&lt;br&gt;Phone" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1060" y="140" width="40" height="80" as="geometry" />
        </mxCell>
        
        <!-- Production Flow Arrows -->
        <mxCell id="pr-arrow1" value="1. Initiate Payment" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#000000;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="690" y="165" as="sourcePoint" />
            <mxPoint x="750" y="165" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="pr-arrow2" value="2. POST /mno/checkout" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#000000;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="850" y="170" as="sourcePoint" />
            <mxPoint x="910" y="170" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="pr-arrow3" value="3. transactionId" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#000000;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="910" y="195" as="sourcePoint" />
            <mxPoint x="850" y="195" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="pr-arrow4" value="4. PENDING" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#000000;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="750" y="200" as="sourcePoint" />
            <mxPoint x="690" y="200" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="pr-arrow5" value="5. Confirm Payment" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#009900;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1060" y="180" as="sourcePoint" />
            <mxPoint x="1010" y="180" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="pr-arrow6" value="6. POST /callback&lt;br&gt;(WEBHOOK)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#009900;strokeWidth=3;fontStyle=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="910" y="260" as="sourcePoint" />
            <mxPoint x="850" y="260" as="targetPoint" />
            <Array as="points">
              <mxPoint x="880" y="260" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <!-- Production Success Box -->
        <mxCell id="pr-success" value="âœ… Webhook received&lt;br&gt;Status â†’ COMPLETED&lt;br&gt;Patient funding updated&lt;br&gt;AUTOMATIC!" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ccffcc;strokeColor=#009900;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="750" y="300" width="200" height="80" as="geometry" />
        </mxCell>
        
        <mxCell id="pr-arrow7" value="7. Confirmation" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#009900;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="750" y="400" as="sourcePoint" />
            <mxPoint x="690" y="400" as="targetPoint" />
            <Array as="points">
              <mxPoint x="720" y="400" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <!-- Legend -->
        <mxCell id="legend-title" value="Legend" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="420" width="100" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-solid" value="Request" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#000000;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="40" y="460" as="sourcePoint" />
            <mxPoint x="120" y="460" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="legend-dashed" value="Response" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#000000;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="40" y="490" as="sourcePoint" />
            <mxPoint x="120" y="490" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="legend-webhook" value="Webhook (Auto)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#009900;strokeWidth=3;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="40" y="520" as="sourcePoint" />
            <mxPoint x="120" y="520" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
  
  <diagram name="Webhook Architecture" id="webhook-arch">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="827" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Title -->
        <mxCell id="arch-title" value="Production Webhook Architecture" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=20;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="370" y="20" width="430" height="40" as="geometry" />
        </mxCell>
        
        <!-- Internet Cloud -->
        <mxCell id="internet" value="Internet" style="ellipse;shape=cloud;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="80" y="100" width="200" height="100" as="geometry" />
        </mxCell>
        
        <!-- Customer -->
        <mxCell id="customer" value="Customer&lt;br&gt;Mobile Phone" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="160" y="250" width="40" height="80" as="geometry" />
        </mxCell>
        
        <!-- AzamPay -->
        <mxCell id="azampay" value="AzamPay&lt;br&gt;Gateway" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="360" y="120" width="120" height="80" as="geometry" />
        </mxCell>
        
        <!-- HTTPS Connection -->
        <mxCell id="https" value="HTTPS&lt;br&gt;(SSL Required)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#009900;strokeWidth=3;fontStyle=1;" edge="1" parent="1" source="azampay" target="nginx">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="420" y="200" as="sourcePoint" />
            <mxPoint x="620" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Nginx/Apache -->
        <mxCell id="nginx" value="Nginx/Apache&lt;br&gt;Web Server&lt;br&gt;:443 (HTTPS)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="620" y="120" width="140" height="80" as="geometry" />
        </mxCell>
        
        <!-- Django App -->
        <mxCell id="django" value="Django App&lt;br&gt;(Gunicorn)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="620" y="260" width="140" height="80" as="geometry" />
        </mxCell>
        
        <mxCell id="nginx-django" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#000000;strokeWidth=2;" edge="1" parent="1" source="nginx" target="django">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Middleware -->
        <mxCell id="middleware" value="Middleware Stack" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="620" y="380" width="140" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="django-middleware" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#000000;" edge="1" parent="1" source="django" target="middleware">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Callback View -->
        <mxCell id="callback-view" value="AzamPayCallbackView&lt;br&gt;/api/v1.0/donors/payment/azampay/callback/&lt;br&gt;&lt;br&gt;permission_classes = [AllowAny]" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="580" y="460" width="220" height="80" as="geometry" />
        </mxCell>
        
        <mxCell id="middleware-view" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#000000;" edge="1" parent="1" source="middleware" target="callback-view">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Service Layer -->
        <mxCell id="service" value="AzamPayService&lt;br&gt;process_callback()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="620" y="580" width="140" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="view-service" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#000000;" edge="1" parent="1" source="callback-view" target="service">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Database -->
        <mxCell id="database" value="MySQL Database&lt;br&gt;Donation Table&lt;br&gt;Patient Table" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#f5f5f5;strokeColor=#666666;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="860" y="450" width="140" height="100" as="geometry" />
        </mxCell>
        
        <mxCell id="service-db" value="UPDATE&lt;br&gt;status = COMPLETED" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#009900;strokeWidth=2;fontStyle=1;" edge="1" parent="1" source="service" target="database">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="780" y="610" />
              <mxPoint x="780" y="500" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <!-- Logs -->
        <mxCell id="logs" value="Log Files&lt;br&gt;payments.log&lt;br&gt;django.log&lt;br&gt;errors.log" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="860" y="580" width="140" height="100" as="geometry" />
        </mxCell>
        
        <mxCell id="service-logs" value="LOG" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#cc6600;strokeWidth=2;dashed=1;" edge="1" parent="1" source="service" target="logs">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Process Flow Box -->
        <mxCell id="process-box" value="Webhook Processing:&lt;br&gt;1. Validate payload&lt;br&gt;2. Extract donation ID&lt;br&gt;3. Update status&lt;br&gt;4. Update patient funding&lt;br&gt;5. Log everything&lt;br&gt;6. Return 200 OK" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ccffcc;strokeColor=#009900;fontSize=11;align=left;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="340" y="450" width="200" height="140" as="geometry" />
        </mxCell>
        
        <!-- Customer Payment Flow -->
        <mxCell id="customer-payment" value="1. Customer confirms&lt;br&gt;on phone (USSD)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#0066cc;strokeWidth=2;" edge="1" parent="1" source="customer" target="azampay">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="180" y="220" />
              <mxPoint x="280" y="220" />
              <mxPoint x="280" y="160" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <!-- Security Note -->
        <mxCell id="security" value="ðŸ”’ Security Requirements:&lt;br&gt;âœ… HTTPS/SSL Certificate&lt;br&gt;âœ… Public IP/Domain&lt;br&gt;âœ… AllowAny permission&lt;br&gt;âœ… Firewall allows 443&lt;br&gt;âœ… Webhook password (optional)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffcc;strokeColor=#cccc00;fontSize=10;align=left;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="450" width="220" height="120" as="geometry" />
        </mxCell>
        
        <!-- Response -->
        <mxCell id="response" value="200 OK" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#009900;strokeWidth=3;dashed=1;fontStyle=1;" edge="1" parent="1" source="callback-view" target="azampay">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="540" y="500" />
              <mxPoint x="540" y="300" />
              <mxPoint x="420" y="300" />
            </Array>
          </mxGeometry>
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
  
  <diagram name="Payment Status Flow" id="status-flow">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="827" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Title -->
        <mxCell id="status-title" value="Payment Status Lifecycle" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=20;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="420" y="20" width="330" height="40" as="geometry" />
        </mxCell>
        
        <!-- Status: Created -->
        <mxCell id="status-created" value="CREATED&lt;br&gt;Donation record created" style="ellipse;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="100" y="100" width="140" height="80" as="geometry" />
        </mxCell>
        
        <!-- Status: Pending -->
        <mxCell id="status-pending" value="PENDING&lt;br&gt;Payment initiated&lt;br&gt;Waiting for confirmation" style="ellipse;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="340" y="100" width="160" height="100" as="geometry" />
        </mxCell>
        
        <mxCell id="created-pending" value="Payment initiated&lt;br&gt;(Frontend request)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#000000;strokeWidth=2;" edge="1" parent="1" source="status-created" target="status-pending">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Status: Completed -->
        <mxCell id="status-completed" value="COMPLETED&lt;br&gt;âœ… Payment successful&lt;br&gt;Patient funded updated" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="340" y="300" width="160" height="100" as="geometry" />
        </mxCell>
        
        <mxCell id="pending-completed" value="Webhook: success&lt;br&gt;(Automatic)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#009900;strokeWidth=3;fontStyle=1;" edge="1" parent="1" source="status-pending" target="status-completed">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Status: Failed -->
        <mxCell id="status-failed" value="FAILED&lt;br&gt;âŒ Payment failed&lt;br&gt;Insufficient funds/Error" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="620" y="200" width="160" height="100" as="geometry" />
        </mxCell>
        
        <mxCell id="pending-failed" value="Webhook: failure" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#cc0000;strokeWidth=2;fontStyle=1;" edge="1" parent="1" source="status-pending" target="status-failed">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Status: Cancelled -->
        <mxCell id="status-cancelled" value="CANCELLED&lt;br&gt;âš ï¸ User cancelled&lt;br&gt;No charge" style="ellipse;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="620" y="350" width="160" height="100" as="geometry" />
        </mxCell>
        
        <mxCell id="pending-cancelled" value="Webhook: cancelled" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#cc6600;strokeWidth=2;fontStyle=1;" edge="1" parent="1" source="status-pending" target="status-cancelled">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="560" y="150" />
              <mxPoint x="560" y="400" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <!-- Status: Refunded -->
        <mxCell id="status-refunded" value="REFUNDED&lt;br&gt;ðŸ’° Money returned&lt;br&gt;Patient funding reversed" style="ellipse;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="340" y="500" width="160" height="100" as="geometry" />
        </mxCell>
        
        <mxCell id="completed-refunded" value="Manual refund&lt;br&gt;(Admin action)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#cc6600;strokeWidth=2;fontStyle=1;dashed=1;" edge="1" parent="1" source="status-completed" target="status-refunded">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Webhook Info Box -->
        <mxCell id="webhook-info" value="ðŸ”” Webhook Payload:&lt;br&gt;&lt;br&gt;transactionstatus: &quot;success&quot;&lt;br&gt;externalreference: &quot;RHCI-DN-{id}-...&quot;&lt;br&gt;amount: &quot;50000&quot;&lt;br&gt;operator: &quot;Mpesa&quot;&lt;br&gt;reference: &quot;AZM123...&quot;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ccffcc;strokeColor=#009900;fontSize=10;align=left;fontStyle=0;" vertex="1" parent="1">
          <mxGeometry x="860" y="100" width="260" height="140" as="geometry" />
        </mxCell>
        
        <!-- Database Updates -->
        <mxCell id="db-updates" value="Database Updates (Automatic):&lt;br&gt;&lt;br&gt;âœ… donation.status = 'COMPLETED'&lt;br&gt;âœ… donation.completed_at = now()&lt;br&gt;âœ… donation.transaction_id = reference&lt;br&gt;âœ… patient.funding_received += amount&lt;br&gt;âœ… Check if patient.fully_funded()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;align=left;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="860" y="280" width="260" height="160" as="geometry" />
        </mxCell>
        
        <!-- Logs Box -->
        <mxCell id="logs-box" value="ðŸ“‹ Logs Generated:&lt;br&gt;&lt;br&gt;logs/payments.log:&lt;br&gt;  &quot;Received Azam Pay callback&quot;&lt;br&gt;  &quot;Processed callback&quot;&lt;br&gt;  &quot;âœ… Donation 123 completed successfully&quot;&lt;br&gt;&lt;br&gt;logs/django.log:&lt;br&gt;  Request/response details" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffcc;strokeColor=#cccc00;fontSize=10;align=left;fontStyle=0;" vertex="1" parent="1">
          <mxGeometry x="860" y="480" width="260" height="160" as="geometry" />
        </mxCell>
        
        <!-- Timing Info -->
        <mxCell id="timing" value="â±ï¸ Timing:&lt;br&gt;&lt;br&gt;Payment initiated â†’ PENDING: &lt;1 second&lt;br&gt;Customer confirms â†’ Webhook: 2-30 seconds&lt;br&gt;Webhook â†’ Status updated: &lt;1 second&lt;br&gt;&lt;br&gt;Total: ~5-45 seconds average" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;align=left;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="100" y="300" width="200" height="140" as="geometry" />
        </mxCell>
        
        <!-- Manual Check (Sandbox) -->
        <mxCell id="manual-check" value="ðŸ§ª Sandbox Only:&lt;br&gt;Manual status check needed&lt;br&gt;&lt;br&gt;GET /payment/status/?donation_id=123" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffcccc;strokeColor=#ff0000;fontSize=10;align=left;fontStyle=1;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="100" y="480" width="200" height="100" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
